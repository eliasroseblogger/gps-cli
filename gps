#!/bin/bash

# GPS CLI - Universal Device Location Tracker
# Supports multiple providers: Traccar, OwnTracks, PhoneTrack, GPSLogger

VERSION="0.1.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DATA_DIR="$HOME/.config/gps-cli"
CONFIG_FILE="$DATA_DIR/config.json"
HISTORY_FILE="$DATA_DIR/history.json"
LOG_FILE="$DATA_DIR/gps.log"
PID_FILE="$DATA_DIR/tracker.pid"
ENV_FILE="$DATA_DIR/.env"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m'

# Initialize data directory
init_data_dir() {
    mkdir -p "$DATA_DIR" "$DATA_DIR/providers"
    if [ ! -f "$CONFIG_FILE" ]; then
        echo '{
  "provider": "none",
  "device_id": "",
  "update_interval": 60,
  "gps_source": "auto",
  "tracking_url": "",
  "last_location": {}
}' > "$CONFIG_FILE"
    fi
    if [ ! -f "$HISTORY_FILE" ]; then
        echo "[]" > "$HISTORY_FILE"
    fi
}

# Print colored message
print_msg() {
    local color=$1
    shift
    echo -e "${color}$@${NC}"
}

# Log message
log_msg() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Load environment variables
load_env() {
    if [ -f "$ENV_FILE" ]; then
        export $(grep -v '^#' "$ENV_FILE" | xargs)
    fi
}

# Get config value
get_config() {
    local key=$1
    jq -r ".$key // empty" "$CONFIG_FILE" 2>/dev/null
}

# Set config value
set_config() {
    local key=$1
    local value=$2
    local tmp=$(mktemp)
    jq --arg k "$key" --arg v "$value" '.[$k] = $v' "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"
    log_msg "Config updated: $key = $value"
}

# Generate unique device ID
generate_device_id() {
    local hostname=$(hostname)
    local timestamp=$(date +%s)
    local random=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 8 | head -n 1)
    echo "${hostname}-${random}-${timestamp}" | md5sum | cut -d' ' -f1 | cut -c1-12
}

# Get current location using IP geolocation
get_ip_location() {
    print_msg "$CYAN" "üì° Getting location from IP address..."
    
    # Try ipapi.co first
    local result=$(curl -s "https://ipapi.co/json/" 2>/dev/null)
    if [ -n "$result" ]; then
        local lat=$(echo "$result" | jq -r '.latitude // empty')
        local lon=$(echo "$result" | jq -r '.longitude // empty')
        local city=$(echo "$result" | jq -r '.city // "Unknown"')
        local country=$(echo "$result" | jq -r '.country_name // "Unknown"')
        
        if [ -n "$lat" ] && [ -n "$lon" ]; then
            echo "{\"latitude\": $lat, \"longitude\": $lon, \"city\": \"$city\", \"country\": \"$country\", \"accuracy\": \"ip\", \"timestamp\": \"$(date -Iseconds)\"}"
            return 0
        fi
    fi
    
    # Fallback to ip-api.com
    result=$(curl -s "http://ip-api.com/json/" 2>/dev/null)
    if [ -n "$result" ]; then
        local lat=$(echo "$result" | jq -r '.lat // empty')
        local lon=$(echo "$result" | jq -r '.lon // empty')
        local city=$(echo "$result" | jq -r '.city // "Unknown"')
        local country=$(echo "$result" | jq -r '.country // "Unknown"')
        
        if [ -n "$lat" ] && [ -n "$lon" ]; then
            echo "{\"latitude\": $lat, \"longitude\": $lon, \"city\": \"$city\", \"country\": \"$country\", \"accuracy\": \"ip\", \"timestamp\": \"$(date -Iseconds)\"}"
            return 0
        fi
    fi
    
    print_msg "$RED" "‚ùå Failed to get IP location"
    return 1
}

# Check for GPS hardware
check_gps_hardware() {
    if command -v gpsd >/dev/null 2>&1 && command -v cgps >/dev/null 2>&1; then
        if pgrep -x gpsd >/dev/null; then
            return 0
        fi
    fi
    return 1
}

# Setup provider
setup_provider() {
    print_msg "$BLUE" "üõ∞Ô∏è  GPS CLI Setup - Choose Your Tracking Provider"
    echo ""
    print_msg "$GREEN" "Available Providers:"
    echo "  1) Traccar (Recommended - Free demo available)"
    echo "     ‚Ä¢ Web-based tracking interface"
    echo "     ‚Ä¢ Real-time map view"
    echo "     ‚Ä¢ Free demo server or self-hosted"
    echo ""
    echo "  2) OwnTracks (Privacy-focused)"
    echo "     ‚Ä¢ Self-hosted MQTT/HTTP"
    echo "     ‚Ä¢ End-to-end encryption"
    echo "     ‚Ä¢ Requires own server"
    echo ""
    echo "  3) PhoneTrack (Nextcloud)"
    echo "     ‚Ä¢ Requires Nextcloud instance"
    echo "     ‚Ä¢ Session-based tracking"
    echo "     ‚Ä¢ Privacy-first"
    echo ""
    echo "  4) GPSLogger (Custom backend)"
    echo "     ‚Ä¢ Send to any HTTP endpoint"
    echo "     ‚Ä¢ Maximum flexibility"
    echo ""
    
    read -p "Select provider [1-4]: " choice
    
    case $choice in
        1)
            setup_traccar
            ;;
        2)
            setup_owntracks
            ;;
        3)
            setup_phonetrack
            ;;
        4)
            setup_gpslogger
            ;;
        *)
            print_msg "$RED" "‚ùå Invalid choice"
            return 1
            ;;
    esac
}

# Setup Traccar
setup_traccar() {
    print_msg "$BLUE" "üìç Setting up Traccar..."
    echo ""
    print_msg "$CYAN" "Traccar Options:"
    echo "  1) Use FREE Traccar Demo Server (Easy - Recommended for testing)"
    echo "  2) Use my own Traccar Server (Self-hosted)"
    echo ""
    
    read -p "Select option [1-2]: " option
    
    local server=""
    local port=5055
    
    if [ "$option" = "1" ]; then
        server="https://demo2.traccar.org"
        print_msg "$GREEN" "‚úÖ Using Traccar Demo Server"
    else
        read -p "Enter your Traccar server URL (e.g., https://your-server.com): " server
        read -p "Enter port [5055]: " custom_port
        port=${custom_port:-5055}
    fi
    
    # Generate device ID
    local device_id=$(generate_device_id)
    
    # Save configuration
    set_config "provider" "traccar"
    set_config "device_id" "$device_id"
    
    local tmp=$(mktemp)
    jq --arg s "$server" --argjson p "$port" '.traccar_server = $s | .traccar_port = $p' "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"
    
    # Generate tracking URL
    local tracking_url="${server}/?deviceId=${device_id}"
    set_config "tracking_url" "$tracking_url"
    
    echo ""
    print_msg "$GREEN" "‚úÖ Traccar configured successfully!"
    print_msg "$GREEN" "üì± Device ID: $device_id"
    print_msg "$YELLOW" "üó∫Ô∏è  Tracking URL: $tracking_url"
    echo ""
    print_msg "$CYAN" "üí° Next steps:"
    echo "   1. Run: gps start"
    echo "   2. Open tracking URL in browser to see your location"
    echo ""
    
    log_msg "Traccar setup completed: $server, device: $device_id"
}

# Setup OwnTracks
setup_owntracks() {
    print_msg "$BLUE" "üìç Setting up OwnTracks..."
    echo ""
    print_msg "$YELLOW" "‚ö†Ô∏è  OwnTracks requires:"
    echo "   ‚Ä¢ MQTT broker (Mosquitto) or HTTP endpoint"
    echo "   ‚Ä¢ Self-hosted recorder for web interface"
    echo ""
    
    read -p "Enter your OwnTracks HTTP endpoint: " endpoint
    read -p "Enter username (optional): " username
    read -p "Enter password (optional): " password
    
    local device_id=$(generate_device_id)
    
    set_config "provider" "owntracks"
    set_config "device_id" "$device_id"
    
    # Save to env file
    cat > "$ENV_FILE" << EOF
# OwnTracks Configuration
OWNTRACKS_ENDPOINT=$endpoint
OWNTRACKS_USERNAME=$username
OWNTRACKS_PASSWORD=$password
EOF
    
    print_msg "$GREEN" "‚úÖ OwnTracks configured!"
    print_msg "$CYAN" "üì± Device ID: $device_id"
    log_msg "OwnTracks setup completed: $endpoint"
}

# Setup PhoneTrack
setup_phonetrack() {
    print_msg "$BLUE" "üìç Setting up PhoneTrack..."
    echo ""
    print_msg "$YELLOW" "‚ö†Ô∏è  PhoneTrack requires:"
    echo "   ‚Ä¢ Nextcloud instance with PhoneTrack app"
    echo "   ‚Ä¢ Session token from PhoneTrack"
    echo ""
    
    read -p "Enter your Nextcloud URL: " nextcloud_url
    read -p "Enter PhoneTrack session token: " session_token
    read -p "Enter device name: " device_name
    
    local device_id=${device_name:-$(generate_device_id)}
    
    set_config "provider" "phonetrack"
    set_config "device_id" "$device_id"
    
    cat > "$ENV_FILE" << EOF
# PhoneTrack Configuration
PHONETRACK_URL=$nextcloud_url
PHONETRACK_SESSION=$session_token
PHONETRACK_DEVICE=$device_id
EOF
    
    local tracking_url="${nextcloud_url}/apps/phonetrack"
    set_config "tracking_url" "$tracking_url"
    
    print_msg "$GREEN" "‚úÖ PhoneTrack configured!"
    print_msg "$CYAN" "üó∫Ô∏è  Tracking URL: $tracking_url"
    log_msg "PhoneTrack setup completed: $nextcloud_url"
}

# Setup GPSLogger
setup_gpslogger() {
    print_msg "$BLUE" "üìç Setting up GPSLogger..."
    echo ""
    
    read -p "Enter your HTTP endpoint URL: " endpoint
    read -p "Enter authentication header (optional): " auth_header
    
    local device_id=$(generate_device_id)
    
    set_config "provider" "gpslogger"
    set_config "device_id" "$device_id"
    
    cat > "$ENV_FILE" << EOF
# GPSLogger Configuration
GPSLOGGER_ENDPOINT=$endpoint
GPSLOGGER_AUTH=$auth_header
EOF
    
    print_msg "$GREEN" "‚úÖ GPSLogger configured!"
    print_msg "$CYAN" "üì± Device ID: $device_id"
    log_msg "GPSLogger setup completed: $endpoint"
}

# Send location update
send_location() {
    local provider=$(get_config "provider")
    local device_id=$(get_config "device_id")
    local location="$1"
    
    if [ -z "$location" ]; then
        return 1
    fi
    
    local lat=$(echo "$location" | jq -r '.latitude')
    local lon=$(echo "$location" | jq -r '.longitude')
    local timestamp=$(date +%s)
    
    case "$provider" in
        traccar)
            local server=$(get_config "traccar_server")
            local port=$(get_config "traccar_port")
            local url="${server}:${port}/?id=${device_id}&lat=${lat}&lon=${lon}&timestamp=${timestamp}"
            curl -s "$url" >/dev/null 2>&1
            ;;
        owntracks)
            load_env
            local payload=$(jq -n \
                --arg lat "$lat" \
                --arg lon "$lon" \
                --arg tid "$device_id" \
                --argjson tst "$timestamp" \
                '{_type: "location", lat: ($lat|tonumber), lon: ($lon|tonumber), tid: $tid, tst: $tst}')
            curl -s -X POST "$OWNTRACKS_ENDPOINT" \
                -u "$OWNTRACKS_USERNAME:$OWNTRACKS_PASSWORD" \
                -H "Content-Type: application/json" \
                -d "$payload" >/dev/null 2>&1
            ;;
        phonetrack)
            load_env
            local url="${PHONETRACK_URL}/apps/phonetrack/logPost/${PHONETRACK_SESSION}/${PHONETRACK_DEVICE}/${lat}/${lon}"
            curl -s "$url" >/dev/null 2>&1
            ;;
        gpslogger)
            load_env
            local payload="{\"device_id\": \"$device_id\", \"latitude\": $lat, \"longitude\": $lon, \"timestamp\": $timestamp}"
            curl -s -X POST "$GPSLOGGER_ENDPOINT" \
                -H "Authorization: $GPSLOGGER_AUTH" \
                -H "Content-Type: application/json" \
                -d "$payload" >/dev/null 2>&1
            ;;
    esac
    
    # Save to history
    local entry=$(jq -n \
        --argjson loc "$location" \
        --arg ts "$(date -Iseconds)" \
        --arg p "$provider" \
        '{location: $loc, timestamp: $ts, provider: $p}')
    jq --argjson e "$entry" '. += [$e] | .[-50:]' "$HISTORY_FILE" > "$HISTORY_FILE.tmp" && mv "$HISTORY_FILE.tmp" "$HISTORY_FILE"
    
    # Update last location in config
    local tmp=$(mktemp)
    jq --argjson loc "$location" '.last_location = $loc' "$CONFIG_FILE" > "$tmp" && mv "$tmp" "$CONFIG_FILE"
}

# Start tracking
start_tracking() {
    local provider=$(get_config "provider")
    
    if [ "$provider" = "none" ]; then
        print_msg "$RED" "‚ùå No provider configured. Run: gps setup"
        return 1
    fi
    
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            print_msg "$YELLOW" "‚ö†Ô∏è  Tracking is already running (PID: $pid)"
            return 0
        fi
    fi
    
    print_msg "$CYAN" "üöÄ Starting GPS tracking..."
    
    # Get initial location
    local location=$(get_ip_location)
    if [ -n "$location" ]; then
        send_location "$location"
        local city=$(echo "$location" | jq -r '.city')
        local country=$(echo "$location" | jq -r '.country')
        print_msg "$GREEN" "‚úÖ Initial location: $city, $country"
    fi
    
    # Start background tracking
    (
        while true; do
            location=$(get_ip_location)
            if [ -n "$location" ]; then
                send_location "$location"
                log_msg "Location updated: $(echo $location | jq -c .)"
            fi
            sleep $(get_config "update_interval")
        done
    ) &
    
    echo $! > "$PID_FILE"
    
    print_msg "$GREEN" "‚úÖ Tracking started!"
    print_msg "$CYAN" "üì± Device ID: $(get_config 'device_id')"
    
    local tracking_url=$(get_config "tracking_url")
    if [ -n "$tracking_url" ]; then
        print_msg "$YELLOW" "üó∫Ô∏è  Track at: $tracking_url"
    fi
    
    print_msg "$BLUE" "üí° Use 'gps status' to check tracking"
    print_msg "$BLUE" "üí° Use 'gps stop' to stop tracking"
    
    log_msg "Tracking started with provider: $provider"
}

# Stop tracking
stop_tracking() {
    if [ ! -f "$PID_FILE" ]; then
        print_msg "$YELLOW" "‚ö†Ô∏è  Tracking is not running"
        return 0
    fi
    
    local pid=$(cat "$PID_FILE")
    
    if ps -p "$pid" > /dev/null 2>&1; then
        kill "$pid"
        print_msg "$GREEN" "‚úÖ Tracking stopped"
        log_msg "Tracking stopped (PID: $pid)"
    else
        print_msg "$YELLOW" "‚ö†Ô∏è  Tracking process not found"
    fi
    
    rm -f "$PID_FILE"
}

# Show status
show_status() {
    print_msg "$BLUE" "üìä GPS Tracking Status"
    echo ""
    
    local provider=$(get_config "provider")
    local device_id=$(get_config "device_id")
    local interval=$(get_config "update_interval")
    local tracking_url=$(get_config "tracking_url")
    
    print_msg "$CYAN" "Provider: $provider"
    print_msg "$CYAN" "Device ID: $device_id"
    print_msg "$CYAN" "Update Interval: ${interval}s"
    echo ""
    
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            print_msg "$GREEN" "‚úÖ Status: Tracking Active (PID: $pid)"
        else
            print_msg "$RED" "‚ùå Status: Stopped (stale PID file)"
            rm -f "$PID_FILE"
        fi
    else
        print_msg "$YELLOW" "‚ö†Ô∏è  Status: Not Running"
    fi
    
    echo ""
    
    # Show last location
    local last_loc=$(jq -r '.last_location' "$CONFIG_FILE")
    if [ "$last_loc" != "{}" ] && [ "$last_loc" != "null" ]; then
        print_msg "$CYAN" "üìç Last Known Location:"
        echo "$last_loc" | jq -r '"  Latitude: \(.latitude)\n  Longitude: \(.longitude)\n  City: \(.city // "Unknown")\n  Country: \(.country // "Unknown")\n  Time: \(.timestamp // "Unknown")"'
    fi
    
    echo ""
    if [ -n "$tracking_url" ] && [ "$tracking_url" != "null" ]; then
        print_msg "$YELLOW" "üó∫Ô∏è  Tracking URL:"
        echo "  $tracking_url"
    fi
}

# Show tracking URL
show_url() {
    local tracking_url=$(get_config "tracking_url")
    
    if [ -z "$tracking_url" ] || [ "$tracking_url" = "null" ]; then
        print_msg "$RED" "‚ùå No tracking URL available"
        print_msg "$YELLOW" "üí° Run 'gps setup' first"
        return 1
    fi
    
    print_msg "$YELLOW" "üó∫Ô∏è  Your Tracking URL:"
    echo ""
    print_msg "$GREEN" "$tracking_url"
    echo ""
    print_msg "$CYAN" "üí° Open this URL in a browser to see device location on map"
}

# Configure settings
configure() {
    print_msg "$BLUE" "‚öôÔ∏è  GPS CLI Configuration"
    echo ""
    
    local current_interval=$(get_config "update_interval")
    print_msg "$CYAN" "Current update interval: ${current_interval}s"
    echo ""
    
    read -p "Enter new update interval in seconds [${current_interval}]: " new_interval
    new_interval=${new_interval:-$current_interval}
    
    if [[ "$new_interval" =~ ^[0-9]+$ ]]; then
        set_config "update_interval" "$new_interval"
        print_msg "$GREEN" "‚úÖ Update interval set to ${new_interval}s"
        
        # Restart tracking if active
        if [ -f "$PID_FILE" ]; then
            print_msg "$YELLOW" "‚ö†Ô∏è  Restarting tracking with new settings..."
            stop_tracking
            sleep 1
            start_tracking
        fi
    else
        print_msg "$RED" "‚ùå Invalid interval"
        return 1
    fi
}

# Show history
show_history() {
    print_msg "$BLUE" "üìú Location History"
    echo ""
    
    local count=$(jq 'length' "$HISTORY_FILE")
    
    if [ "$count" -eq 0 ]; then
        print_msg "$YELLOW" "No location history yet"
        return 0
    fi
    
    jq -r '.[] | "[\(.timestamp)] \(.location.city // "Unknown"), \(.location.country // "Unknown") - \(.location.latitude), \(.location.longitude)"' "$HISTORY_FILE" | tail -20
}

# Show help
show_help() {
    cat << HELP
GPS CLI - Universal Device Location Tracker v${VERSION}

Usage: gps <command> [options]

Commands:
  setup               Setup tracking provider and configuration
  start               Start GPS tracking
  stop                Stop GPS tracking
  status              Show tracking status and last location
  url                 Display tracking URL for web viewing
  config              Configure update interval and settings
  history             Show location history
  providers           List available providers
  help                Show this help message

Examples:
  gps setup           # First-time setup
  gps start           # Start tracking
  gps url             # Get web tracking URL
  gps status          # Check if tracking is active
  gps stop            # Stop tracking

Providers:
  ‚Ä¢ Traccar - Free demo server or self-hosted (Recommended)
  ‚Ä¢ OwnTracks - Privacy-focused MQTT/HTTP tracking
  ‚Ä¢ PhoneTrack - Nextcloud-based tracking
  ‚Ä¢ GPSLogger - Custom HTTP endpoint

Web Tracking:
  After setup, use the tracking URL to view device location
  on an interactive map in real-time from any web browser.

Update Interval:
  Default: 60 seconds (1 minute)
  Configure with: gps config

Data Location:
  Configuration: ~/.config/gps-cli/
  Logs: ~/.config/gps-cli/gps.log

HELP
}

# List providers
list_providers() {
    print_msg "$BLUE" "üì° Available GPS Tracking Providers"
    echo ""
    print_msg "$GREEN" "1. Traccar (Recommended)"
    echo "   ‚Ä¢ Free demo server: https://demo2.traccar.org"
    echo "   ‚Ä¢ Self-hosted option available"
    echo "   ‚Ä¢ Web-based map interface"
    echo "   ‚Ä¢ Real-time tracking"
    echo ""
    print_msg "$CYAN" "2. OwnTracks"
    echo "   ‚Ä¢ Privacy-focused"
    echo "   ‚Ä¢ Requires MQTT broker or HTTP endpoint"
    echo "   ‚Ä¢ Self-hosted only"
    echo "   ‚Ä¢ End-to-end encryption"
    echo ""
    print_msg "$MAGENTA" "3. PhoneTrack"
    echo "   ‚Ä¢ Nextcloud app required"
    echo "   ‚Ä¢ Session-based tracking"
    echo "   ‚Ä¢ Privacy-first design"
    echo ""
    print_msg "$YELLOW" "4. GPSLogger"
    echo "   ‚Ä¢ Custom HTTP endpoint"
    echo "   ‚Ä¢ Maximum flexibility"
    echo "   ‚Ä¢ DIY integration"
}

# Main function
main() {
    init_data_dir
    
    case "${1:-help}" in
        setup)
            setup_provider
            ;;
        start)
            start_tracking
            ;;
        stop)
            stop_tracking
            ;;
        status|s)
            show_status
            ;;
        url|link)
            show_url
            ;;
        config|configure)
            configure
            ;;
        history|h)
            show_history
            ;;
        providers|list)
            list_providers
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_msg "$RED" "‚ùå Unknown command: $1"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

main "$@"
